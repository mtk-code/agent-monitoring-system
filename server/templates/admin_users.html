<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin - Users Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="p-4">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>User Management</h1>
        <div>
          <a href="/ui/admin/orgs" class="btn btn-sm btn-secondary">Back</a>
        </div>
      </div>

      <div class="mb-3">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">Create User</button>
      </div>

      <div id="successMsg" class="alert alert-success" style="display:none;"></div>
      <div id="errorMsg" class="alert alert-danger" style="display:none;"></div>

      <table class="table table-striped table-sm">
        <thead>
          <tr>
            <th>ID</th>
            <th>Email</th>
            <th>Organization</th>
            <th>Is Admin</th>
            <th>Created At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTable">
          <tr><td colspan="6" class="text-center">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Create User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form id="createUserForm">
            <div class="modal-body">
              <div class="mb-2">
                <label class="form-label">Email</label>
                <input type="email" id="userEmail" class="form-control" placeholder="user@example.local" required>
              </div>
              <div class="mb-2">
                <label class="form-label">Organization</label>
                <select id="userOrgSelect" class="form-select" required>
                  <option value="">Select org...</option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label">Password</label>
                <input type="password" id="userPassword" class="form-control" placeholder="Choose a password" required>
              </div>
              <div class="form-check">
                <input type="checkbox" id="userIsAdmin" class="form-check-input">
                <label class="form-check-label" for="userIsAdmin">Is Admin</label>
              </div>
              <div id="createErr" class="text-danger mt-2"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Create</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const createModal = new bootstrap.Modal(document.getElementById('createUserModal'));

      function showSuccess(msg) {
        const el = document.getElementById('successMsg');
        el.innerText = msg;
        el.style.display = 'block';
        setTimeout(() => { el.style.display = 'none'; }, 4000);
      }

      function showError(msg) {
        const el = document.getElementById('errorMsg');
        el.innerText = msg;
        el.style.display = 'block';
      }

      async function loadUsers() {
        try {
          const res = await fetch('/api/admin/users', { credentials: 'same-origin' });
          if (res.status === 401 || res.status === 403) {
            window.location.href = '/login';
            return;
          }
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          
          const tbody = document.getElementById('usersTable');
          tbody.innerHTML = '';
          
          if (!data.users || data.users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No users</td></tr>';
          } else {
            data.users.forEach(user => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${user.id}</td>
                <td>${user.email}</td>
                <td>${user.org_name || 'â€”'}</td>
                <td>${user.is_admin === 1 ? 'Yes' : 'No'}</td>
                <td>${user.created_at}</td>
                <td>
                  ${user.is_admin !== 1 ? 
                    `<button class="btn btn-sm btn-outline-primary" onclick="promoteUser(${user.id}, this)">Promote</button>` :
                    `<button class="btn btn-sm btn-outline-warning" onclick="demoteUser(${user.id}, this)">Demote</button>`
                  }
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id}, '${user.email}')">Delete</button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          }

          // Load orgs for create modal
          await loadOrgsForSelect();
        } catch (e) {
          console.error('Load users failed:', e);
          showError('Failed to load users: ' + String(e));
        }
      }

      async function loadOrgsForSelect() {
        try {
          const res = await fetch('/api/orgs', { credentials: 'same-origin' });
          if (!res.ok) return;
          const data = await res.json();
          const select = document.getElementById('userOrgSelect');
          select.innerHTML = '<option value="">Select org...</option>';
          if (data.orgs && Array.isArray(data.orgs)) {
            data.orgs.forEach(org => {
              const opt = document.createElement('option');
              opt.value = org.id;
              opt.innerText = org.name;
              select.appendChild(opt);
            });
          }
        } catch (e) {
          console.error('Load orgs failed:', e);
        }
      }

      async function promoteUser(userId, btn) {
        try {
          btn.disabled = true;
          const res = await fetch(`/api/admin/users/${userId}/promote`, {
            method: 'POST',
            credentials: 'same-origin'
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          showSuccess('User promoted');
          await loadUsers();
        } catch (e) {
          showError('Promote failed: ' + String(e));
          btn.disabled = false;
        }
      }

      async function demoteUser(userId, btn) {
        try {
          btn.disabled = true;
          const res = await fetch(`/api/admin/users/${userId}/demote`, {
            method: 'POST',
            credentials: 'same-origin'
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          showSuccess('User demoted');
          await loadUsers();
        } catch (e) {
          showError('Demote failed: ' + String(e));
          btn.disabled = false;
        }
      }

      async function deleteUser(userId, email) {
        if (!confirm(`Delete user ${email}?`)) return;
        try {
          const res = await fetch(`/api/admin/users/${userId}`, {
            method: 'DELETE',
            credentials: 'same-origin'
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          showSuccess('User deleted');
          await loadUsers();
        } catch (e) {
          showError('Delete failed: ' + String(e));
        }
      }

      document.getElementById('createUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('userEmail').value.trim();
        const org_id = parseInt(document.getElementById('userOrgSelect').value, 10);
        const password = document.getElementById('userPassword').value;
        const is_admin = document.getElementById('userIsAdmin').checked ? 1 : 0;
        if (!email || !org_id || !password) return;
        
        try {
          const res = await fetch('/api/admin/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ email, org_id, password, is_admin })
          });
          if (!res.ok) {
            let data = await res.json().catch(() => ({}));
            throw new Error(data.detail || data.error || `HTTP ${res.status}`);
          }
          showSuccess('User created');
          document.getElementById('userEmail').value = '';
          document.getElementById('userPassword').value = '';
          document.getElementById('userIsAdmin').checked = false;
          document.getElementById('createErr').innerText = '';
          createModal.hide();
          await loadUsers();
        } catch (e) {
          console.error('Create user failed:', e);
          document.getElementById('createErr').innerText = 'Error: ' + String(e);
        }
      });

      loadUsers();
    </script>
  </body>
</html>