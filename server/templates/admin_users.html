<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin - Users Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="p-4">
    <div class="container">
      <div style="text-align: right; margin-bottom: 10px;">
        <select id="langSelect" class="form-select form-select-sm d-inline-block" style="width: auto;">
          <option value="en">English</option>
          <option value="tr">Türkçe</option>
        </select>
      </div>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 id="pageTitle">User Management</h1>
        <div>
          <a href="/ui/admin/orgs" class="btn btn-sm btn-secondary" id="btnBack">Back</a>
        </div>
      </div>

      <div class="mb-3">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal" id="btnCreateUser">Create User</button>
      </div>

      <div id="successMsg" class="alert alert-success" style="display:none;"></div>
      <div id="errorMsg" class="alert alert-danger" style="display:none;"></div>

      <table class="table table-striped table-sm">
        <thead>
          <tr>
            <th id="thId">ID</th>
            <th id="thEmail">Email</th>
            <th id="thOrg">Organization</th>
            <th id="thIsAdmin">Is Admin</th>
            <th id="thCreatedAt">Created At</th>
            <th id="thActions">Actions</th>
          </tr>
        </thead>
        <tbody id="usersTable">
          <tr><td colspan="6" class="text-center">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Create User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form id="createUserForm">
            <div class="modal-body">
              <div class="mb-2">
                <label class="form-label" id="labelEmail">Email</label>
                <input type="email" id="userEmail" class="form-control" placeholder="user@example.local" required>
              </div>
              <div class="mb-2">
                <label class="form-label" id="labelOrg">Organization</label>
                <select id="userOrgSelect" class="form-select" required>
                  <option value="">Select org...</option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label" id="labelPassword">Password</label>
                <input type="password" id="userPassword" class="form-control" placeholder="Choose a password" required>
              </div>
              <div class="form-check">
                <input type="checkbox" id="userIsAdmin" class="form-check-input">
                <label class="form-check-label" for="userIsAdmin" id="labelIsAdmin">Is Admin</label>
              </div>
              <div id="createErr" class="text-danger mt-2"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnCancel">Cancel</button>
              <button type="submit" class="btn btn-primary" id="btnCreateSubmit">Create</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let currentLang = localStorage.getItem('lang') || 'en';
      let translations = {};

      async function loadTranslations(lang) {
        try {
          const res = await fetch(`/api/translations/${lang}`);
          if (res.ok) {
            translations = await res.json();
            currentLang = lang;
            localStorage.setItem('lang', lang);
            updateUIText();
            return true;
          }
        } catch (e) {
          console.error('Failed to load translations:', e);
        }
        return false;
      }

      function t(key, defaultVal = key) {
        const keys = key.split('.');
        let obj = translations;
        for (let k of keys) {
          if (obj && typeof obj === 'object') {
            obj = obj[k];
          } else {
            return defaultVal;
          }
        }
        return obj || defaultVal;
      }

      function updateUIText() {
        document.getElementById('pageTitle').innerText = t('users.title', 'User Management');
        document.getElementById('btnBack').innerText = t('nav.back', 'Back');
        document.getElementById('btnCreateUser').innerText = t('users.create', 'Create User');
        
        document.getElementById('thId').innerText = t('users.id', 'ID');
        document.getElementById('thEmail').innerText = t('users.email', 'Email');
        document.getElementById('thOrg').innerText = t('users.organization', 'Organization');
        document.getElementById('thIsAdmin').innerText = t('users.is_admin', 'Is Admin');
        document.getElementById('thCreatedAt').innerText = t('users.created_at', 'Created At');
        document.getElementById('thActions').innerText = t('users.delete', 'Delete');
        
        document.getElementById('modalTitle').innerText = t('users.create', 'Create User');
        document.getElementById('labelEmail').innerText = t('users.email', 'Email');
        document.getElementById('labelOrg').innerText = t('users.organization', 'Organization');
        document.getElementById('labelPassword').innerText = t('users.password', 'Password');
        document.getElementById('labelIsAdmin').innerText = t('users.is_admin', 'Is Admin');
        document.getElementById('btnCancel').innerText = t('common.cancel', 'Cancel');
        document.getElementById('btnCreateSubmit').innerText = t('users.create_btn', 'Create User');
      }

      const createModal = new bootstrap.Modal(document.getElementById('createUserModal'));

      function showSuccess(msg) {
        const el = document.getElementById('successMsg');
        el.innerText = msg;
        el.style.display = 'block';
        setTimeout(() => { el.style.display = 'none'; }, 4000);
      }

      function showError(msg) {
        const el = document.getElementById('errorMsg');
        el.innerText = msg;
        el.style.display = 'block';
      }

      async function loadUsers() {
        try {
          const res = await fetch('/api/admin/users', { credentials: 'same-origin' });
          if (res.status === 401 || res.status === 403) {
            window.location.href = '/login';
            return;
          }
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          
          const tbody = document.getElementById('usersTable');
          tbody.innerHTML = '';
          
          if (!data.users || data.users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No users</td></tr>';
          } else {
            data.users.forEach(user => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${user.id}</td>
                <td>${user.email}</td>
                <td>${user.org_name || '—'}</td>
                <td>${user.is_admin === 1 ? 'Yes' : 'No'}</td>
                <td>${user.created_at}</td>
                <td>
                  ${user.is_admin !== 1 ? 
                    `<button class="btn btn-sm btn-outline-primary" onclick="promoteUser(${user.id}, this)">Promote</button>` :
                    `<button class="btn btn-sm btn-outline-warning" onclick="demoteUser(${user.id}, this)">Demote</button>`
                  }
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id}, '${user.email}')">Delete</button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          }

          // Load orgs for create modal
          await loadOrgsForSelect();
        } catch (e) {
          console.error('Load users failed:', e);
          showError('Failed to load users: ' + String(e));
        }
      }

      async function loadOrgsForSelect() {
        try {
          const res = await fetch('/api/orgs', { credentials: 'same-origin' });
          if (!res.ok) return;
          const data = await res.json();
          const select = document.getElementById('userOrgSelect');
          select.innerHTML = '<option value="">Select org...</option>';
          if (data.orgs && Array.isArray(data.orgs)) {
            data.orgs.forEach(org => {
              const opt = document.createElement('option');
              opt.value = org.id;
              opt.innerText = org.name;
              select.appendChild(opt);
            });
          }
        } catch (e) {
          console.error('Load orgs failed:', e);
        }
      }

      async function promoteUser(userId, btn) {
        try {
          btn.disabled = true;
          const res = await fetch(`/api/admin/users/${userId}/promote`, {
            method: 'POST',
            credentials: 'same-origin'
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          showSuccess('User promoted');
          await loadUsers();
        } catch (e) {
          showError('Promote failed: ' + String(e));
          btn.disabled = false;
        }
      }

      async function demoteUser(userId, btn) {
        try {
          btn.disabled = true;
          const res = await fetch(`/api/admin/users/${userId}/demote`, {
            method: 'POST',
            credentials: 'same-origin'
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          showSuccess('User demoted');
          await loadUsers();
        } catch (e) {
          showError('Demote failed: ' + String(e));
          btn.disabled = false;
        }
      }

      async function deleteUser(userId, email) {
        if (!confirm(`Delete user ${email}?`)) return;
        try {
          const res = await fetch(`/api/admin/users/${userId}`, {
            method: 'DELETE',
            credentials: 'same-origin'
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          showSuccess('User deleted');
          await loadUsers();
        } catch (e) {
          showError('Delete failed: ' + String(e));
        }
      }

      document.getElementById('createUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('userEmail').value.trim();
        const org_id = parseInt(document.getElementById('userOrgSelect').value, 10);
        const password = document.getElementById('userPassword').value;
        const is_admin = document.getElementById('userIsAdmin').checked ? 1 : 0;
        if (!email || !org_id || !password) return;
        
        try {
          const res = await fetch('/api/admin/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ email, org_id, password, is_admin })
          });
          if (!res.ok) {
            let data = await res.json().catch(() => ({}));
            throw new Error(data.detail || data.error || `HTTP ${res.status}`);
          }
          showSuccess('User created');
          document.getElementById('userEmail').value = '';
          document.getElementById('userPassword').value = '';
          document.getElementById('userIsAdmin').checked = false;
          document.getElementById('createErr').innerText = '';
          createModal.hide();
          await loadUsers();
        } catch (e) {
          console.error('Create user failed:', e);
          document.getElementById('createErr').innerText = 'Error: ' + String(e);
        }
      });

      loadUsers();

      // Language selector
      document.getElementById('langSelect').value = currentLang;
      document.getElementById('langSelect').addEventListener('change', (e) => {
        loadTranslations(e.target.value).then(() => {
          window.location.reload();
        });
      });

      // Load translations on page load
      loadTranslations(currentLang);
    </script>
  </body>
</html>