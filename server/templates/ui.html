<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Agent Monitoring - UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .truncate { max-width: 400px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    </style>
  </head>
  <body class="p-4">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-3">
          <h1 id="pageTitle">Agents</h1>
          <div>
            <span id="refreshText">Auto-refreshing every 10s</span>
            <select id="langSelect" class="form-select form-select-sm d-inline-block" style="width: auto; margin-left: 10px;">
              <option value="en">English</option>
              <option value="tr">Türkçe</option>
            </select>
            <a class="btn btn-sm btn-outline-primary ms-2" href="/org" id="btnOrg">Organization</a>
            {% if user and user.is_admin == 1 %}
            <a class="btn btn-sm btn-outline-danger ms-2" href="/ui/admin/orgs" id="btnAdmin">Admin</a>
            {% endif %}
            <a class="btn btn-sm btn-outline-secondary ms-2" href="/login" id="btnLogout">Logout</a>
          </div>
        </div>
        <div class="mb-3">
          <form id="orgForm" class="d-flex">
            <select id="orgSelect" class="form-select form-select-sm me-2" disabled>
              <option>Organization</option>
            </select>
          </form>
        </div>

      <table class="table table-striped table-sm">
        <thead>
          <tr>
            <th id="thDeviceId">Device ID</th>
            <th id="thHostname">Hostname</th>
            <th id="thOnline">Online</th>
            <th id="thLastSeen">Last Seen</th>
            <th id="thCpu">CPU</th>
            <th id="thRam">RAM</th>
            <th id="thDisk">Disk</th>
            <th id="thUptime">Uptime</th>
            <th id="thAgentVer">Agent Ver</th>
            <th id="thStatus">Status</th>
            <th id="thLastError">Last Error</th>
            <th id="thAction">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for d in devices %}
          <tr>
            <td>{{ d.device_id }}</td>
            <td>{{ d.hostname }}</td>
            <td>
              {% if d.online %}
                <span class="badge bg-success" id="online-{{ d.device_id }}">Online</span>
              {% else %}
                <span class="badge bg-danger" id="offline-{{ d.device_id }}">Offline</span>
              {% endif %}
            </td>
            <td>{{ d.last_seen }}</td>
            <td>{{ d.last_payload.cpu if d.last_payload }}</td>
            <td>{{ d.last_payload.ram if d.last_payload }}</td>
            <td>{{ d.last_payload.disk if d.last_payload }}</td>
            <td>{{ d.last_payload.uptime_sec if d.last_payload }}</td>
            <td>{{ d.last_payload.agent_version if d.last_payload }}</td>
            <td>{{ d.last_payload.status if d.last_payload }}</td>
            <td class="truncate" title="{{ d.last_payload.last_error if d.last_payload }}">{{ (d.last_payload.last_error[:80] + '...') if d.last_payload and d.last_payload.last_error and (d.last_payload.last_error|length > 80) else (d.last_payload.last_error if d.last_payload) }}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="sendRestart('{{ d.device_id }}', this)" id="btnRestart-{{ d.device_id }}">Send restart</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

    </div>

    <script>
      let currentLang = localStorage.getItem('lang') || 'en';
      let translations = {};

      async function loadTranslations(lang) {
        try {
          const res = await fetch(`/api/translations/${lang}`);
          if (res.ok) {
            translations = await res.json();
            currentLang = lang;
            localStorage.setItem('lang', lang);
            updateUIText();
          }
        } catch (e) {
          console.error('Failed to load translations:', e);
        }
      }

      function t(key) {
        const keys = key.split('.');
        let obj = translations;
        for (let k of keys) {
          obj = obj[k];
          if (!obj) return key;
        }
        return obj;
      }

      function updateUIText() {
        document.getElementById('pageTitle').innerText = t('devices.title');
        document.getElementById('refreshText').innerText = t('nav.refresh');
        document.getElementById('btnOrg').innerText = t('nav.organization');
        document.getElementById('btnAdmin').innerText = t('nav.admin');
        document.getElementById('btnLogout').innerText = t('nav.logout');
        
        document.getElementById('thDeviceId').innerText = t('devices.device_id');
        document.getElementById('thHostname').innerText = t('devices.hostname');
        document.getElementById('thOnline').innerText = t('devices.online');
        document.getElementById('thLastSeen').innerText = t('devices.last_seen');
        document.getElementById('thCpu').innerText = t('devices.cpu');
        document.getElementById('thRam').innerText = t('devices.ram');
        document.getElementById('thDisk').innerText = t('devices.disk');
        document.getElementById('thUptime').innerText = t('devices.uptime');
        document.getElementById('thAgentVer').innerText = t('devices.agent_ver');
        document.getElementById('thStatus').innerText = t('devices.status');
        document.getElementById('thLastError').innerText = t('devices.last_error');
        document.getElementById('thAction').innerText = t('devices.action');
        
        // Update button texts
        document.querySelectorAll('[id^="btnRestart-"]').forEach(btn => {
          if (btn.innerText !== 'Sent') btn.innerText = t('devices.send_restart');
        });
        
        // Update online/offline labels
        document.querySelectorAll('[id^="online-"]').forEach(el => {
          el.innerText = t('devices.online');
        });
        document.querySelectorAll('[id^="offline-"]').forEach(el => {
          el.innerText = t('devices.offline');
        });
      }

      document.getElementById('langSelect').value = currentLang;
      document.getElementById('langSelect').addEventListener('change', (e) => {
        loadTranslations(e.target.value);
      });

      loadTranslations(currentLang);

      async function sendRestart(deviceId, btn) {
        try {
          btn.disabled = true;
          const res = await fetch(`/devices/${deviceId}/commands`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ command: 'restart', args: {} })
          });
          if (res.ok) {
            btn.innerText = t('devices.sent');
            setTimeout(() => { btn.innerText = t('devices.send_restart'); btn.disabled = false; }, 2000);
          } else {
            const t_text = await res.text();
            alert('Error: ' + res.status + ' ' + t_text);
            btn.disabled = false;
          }
        } catch (e) {
          alert('Request failed: ' + e);
          btn.disabled = false;
        }
      }

      setTimeout(() => { location.reload(); }, 10000);
    </script>
  </body>
</html>
