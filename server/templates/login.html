<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title id="pageTitle">Login - Agent Monitoring</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="p-4">
    <div class="container" style="max-width:420px">
      <div style="text-align: right; margin-bottom: 20px;">
        <select id="langSelect" class="form-select form-select-sm d-inline-block" style="width: auto;">
          <option value="en">English</option>
          <option value="tr">Türkçe</option>
        </select>
      </div>
      <h2 class="mb-3" id="titleLogin">Sign in</h2>
      <form id="loginForm">
        <div class="mb-2">
          <label class="form-label" id="labelEmail">Email</label>
          <input type="email" id="email" class="form-control" required />
        </div>
        <div class="mb-2">
          <label class="form-label" id="labelPassword">Password</label>
          <input type="password" id="password" class="form-control" required />
        </div>
        <button class="btn btn-primary w-100" type="submit" id="btnSignIn">Sign in</button>
      </form>
      <div id="err" class="text-danger mt-2"></div>
    </div>

    <script>
      let currentLang = localStorage.getItem('lang') || 'en';
      let translations = {};

      async function loadTranslations(lang) {
        try {
          const res = await fetch(`/api/translations/${lang}`);
          if (res.ok) {
            translations = await res.json();
            currentLang = lang;
            localStorage.setItem('lang', lang);
            updateUIText();
            return true;
          }
        } catch (e) {
          console.error('Failed to load translations:', e);
        }
        return false;
      }

      function t(key, defaultVal = key) {
        const keys = key.split('.');
        let obj = translations;
        for (let k of keys) {
          if (obj && typeof obj === 'object') {
            obj = obj[k];
          } else {
            return defaultVal;
          }
        }
        return obj || defaultVal;
      }

      function updateUIText() {
        document.getElementById('titleLogin').innerText = t('login.title', 'Sign in');
        document.getElementById('labelEmail').innerText = t('login.email', 'Email');
        document.getElementById('labelPassword').innerText = t('login.password', 'Password');
        document.getElementById('btnSignIn').innerText = t('login.button', 'Sign in');
      }

      document.getElementById('langSelect').value = currentLang;
      document.getElementById('langSelect').addEventListener('change', (e) => {
        loadTranslations(e.target.value).then(() => {
          window.location.reload();
        });
      });

      loadTranslations(currentLang);

      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        try {
          const res = await fetch('/auth/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email, password})
          });
          if (res.ok) {
            window.location.href = '/ui';
          } else {
            const data = await res.json();
            document.getElementById('err').innerText = data.detail || 'Login failed';
          }
        } catch (e) {
          document.getElementById('err').innerText = String(e);
        }
      });
    </script>
  </body>
</html>
